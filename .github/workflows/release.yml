name: Release iOS

on:
  push:
    tags: ["v*"]

jobs:
  release:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: aarch64-apple-ios

      - name: Install Tauri CLI
        run: cargo install tauri-cli

      - name: Import signing certificate
        env:
          CERTIFICATE_P12: ${{ secrets.CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          CERT_PATH=$RUNNER_TEMP/cert.p12

          echo "$CERTIFICATE_P12" | base64 --decode > "$CERT_PATH"

          security create-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db

      - name: Inject development team
        run: |
          cd rust-app/src-tauri
          jq --arg team "${{ secrets.DEVELOPMENT_TEAM }}" \
            '.bundle.iOS.developmentTeam = $team' tauri.conf.json > tmp.json
          mv tmp.json tauri.conf.json

      - name: Build IPA
        working-directory: rust-app
        run: cargo tauri ios build

      - name: Prepare release
        id: prep
        run: |
          VERSION=$(grep '^version' rust-app/src-tauri/Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          IPA=rust-app/src-tauri/gen/apple/build/arm64/Speedmap.ipa
          IPA_SIZE=$(stat -f%z "$IPA")
          cp "$IPA" speedmap.ipa

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "ipa_size=$IPA_SIZE" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" speedmap.ipa \
            --title "Speedmap ${{ steps.prep.outputs.version }}" \
            --notes "Speedmap ${{ steps.prep.outputs.version }} for iOS"

      - name: Update AltStore source
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${{ steps.prep.outputs.version }}"
          SIZE="${{ steps.prep.outputs.ipa_size }}"
          URL="https://github.com/intervall-ludger/wlan-heatmap/releases/download/$TAG/speedmap.ipa"
          TODAY=$(date +%Y-%m-%d)

          NEW_VERSION=$(jq -n \
            --arg ver "$VERSION" \
            --arg date "$TODAY" \
            --arg url "$URL" \
            --argjson size "$SIZE" \
            '{version:$ver,date:$date,localizedDescription:"",downloadURL:$url,size:$size,minOSVersion:"16.0"}')

          jq --argjson entry "$NEW_VERSION" \
            '.apps[0].versions = [$entry] + .apps[0].versions' \
            altstore/source.json > altstore/source.json.tmp
          mv altstore/source.json.tmp altstore/source.json

      - name: Commit source.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout main
          git add altstore/source.json
          git commit -m "update altstore source for ${{ github.ref_name }}"
          git push
